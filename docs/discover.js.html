<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: discover.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: discover.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Load dependencies
var _ = require('lodash');
var Promise = require('bluebird');
var Hoek = require('hoek');
var Async = require('Async');

// Load hue modules
var Socket = require('./socket');

var internals = {};

/**
 * @class   Discover
 * @param   {Object} hue instance of Hue class
 * @constructor
 */
module.exports = internals.Discover = function Discover(hue) {

  this._hue = hue;
  this._methods = [
    'upnp',
    'nupnp',
    'ip'
  ];

}

/**
 * Performs a search for bridges on the network via three different methods
 * http://www.developers.meethue.com/documentation/hue-bridge-discovery
 *
 * @method  search
 * @param   {String|Array} methods can be a string to search via one method, or an array of search methods ['upnp', 'nupnp', 'ip']
 * @return  {Promise} will return a promise that will resolve when bridge is discovered, or reject if there is an error finding the bridge
 */
internals.Discover.prototype.search = Promise.method(function search(methods) {

  var self = this;

  methods = methods || this._methods;

  Hoek.assert(_.isArray(methods) || _.isString(methods), '`method` must be either a string or an array.');

  if (_.isString(methods)) {
    methods = [methods];
  }

  return self._search = self._search || Promise.any(methods.map(function(method) {

    if (typeof self[method] !== 'function') {
      throw new Error('`' + method + '` is not a valid search method.');
    } else {
      return self[method]();
    }

  })).map(self._hue.description).finally(function() {

    // Make sure we don't keep this search so a new one can be started
    self._search = null;

  }).catch(TypeError, ReferenceError, function(error) {

    // output any developer error so we don't stifle them
    console.log(error);

  }).catch(function(error) {

    // any other type of error will just result in no bridges being found
    return Promise.resolve([]);

  });

});

/**
 * Searches for a bridge via the UPnP method
 * http://www.developers.meethue.com/documentation/hue-bridge-discovery
 *
 * @method upnp
 * @return {Promise} will return a promise that will resolve when bridge is discovered, or reject if there is an error finding the bridge
 */
internals.Discover.prototype.upnp = function upnp() {

  var socket = new Socket();

  return socket.send([
    'M-SEARCH * HTTP/1.1',
    'HOST: 239.255.255.250:1900',
    'MAN: ssdp:discover',
    'MX: 10',
    'ST: ssdp:all'
  ], 1900, "239.255.255.250", 5000).filter(function(messages) {
    return /IpBridge/.test(messages.message);
  }).map(function(messages) {
    return messages.rinfo.address;
  });

}

/**
 * Searches for a bridge via the N-UPnP method
 * http://www.developers.meethue.com/documentation/hue-bridge-discovery
 * https://www.meethue.com/api/nupnp
 *
 * @method nupnp
 * @return {Promise} will return a promise that will resolve when bridge is discovered, or reject if there is an error finding the bridge
 */
internals.Discover.prototype.nupnp = function nupnp() {
  return Promise.reject();
}

/**
 * Searches for a bridge via the IP Scan method
 * http://www.developers.meethue.com/documentation/hue-bridge-discovery
 *
 * @method ip
 * @return {Promise} will return a promise that will resolve when bridge is discovered, or reject if there is an error finding the bridge
 */
internals.Discover.prototype.ip = function ip() {
  return Promise.reject();
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#description">description</a></li><li><a href="global.html#discover">discover</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getSocket">getSocket</a></li><li><a href="global.html#ip">ip</a></li><li><a href="global.html#nupnp">nupnp</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#send">send</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#upnp">upnp</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Wed May 27 2015 18:43:37 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
