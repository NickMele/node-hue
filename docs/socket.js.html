<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: socket.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: socket.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Load dependencies
var Dgram = require('dgram');
var _ = require('lodash');
var Hoek = require('hoek');
var Promise = require('bluebird');

var internals = {};

/**
 * @class Socker
 * @constructor
 */
module.exports = internals.Socket = function Socket() {

  var socket = this._socket = Dgram.createSocket('udp4');

  socket.on('close', function() {
    socket = null;
  });

}

/**
 * Sends a message on the socket and waits for X amount of time for messages
 * https://nodejs.org/api/dgram.html#dgram_socket_send_buf_offset_length_port_address_callback
 *
 * @method  send
 * @param   {Mixed}   payload the payload to be sent to the socket
 * @param   {Number}  port the destination port
 * @param   {String}  address the destination host or ip
 * @param   {Nunber}  timeout the amount of time to listen for returning messages on the socket
 * @return  {Promise} will return a promise that will resolve with the messages responded to on the socket
 */
internals.Socket.prototype.send = Promise.method(function send(payload, port, address, timeout) {

  Hoek.assert(_.isString(payload) || _.isArray(payload), '`payload` must be a string or an array')
  Hoek.assert(_.isNumber(port), '`port` must be a number.');
  Hoek.assert(_.isString(address), '`address` must be a string.');

  var buffer = internals._createBuffer(payload);
  var messages = [];

  return Promise.using(this.getSocket(), function(socket) {
    return new Promise(function(resolve, reject) {

      // listen for errors on the socket
      socket.on('error', reject);

      // listen for messages on the socket
      socket.on('message', function(message, rinfo) {
        messages.push({
          message: message.toString('utf8'),
          original_message: message,
          rinfo: rinfo
        });
      });

      // TODO: remove this test data
      messages.push({
        message: 'IpBridge',
        rinfo: {
          address: '127.0.0.1'
        }
      });

      // Send the packet
      socket.send(buffer, 0, buffer.length, port, address);

      return resolve(messages);

    }).delay(timeout || 0);
  });
});

/**
 * Returns the socket, along with a disposer method that will cleanup the socket when done
 *
 * @method  getSocket
 * @return  {Promise} will return a promise that resolves to the socket created
 */
internals.Socket.prototype.getSocket = Promise.method(function getSocket() {

  var socket = this._socket;

  Hoek.assert(_.isObject(socket), 'Could not find socket to send to the disposer.');

  return Promise.resolve(this._socket).disposer(function(socket) {
    if (socket) {
      socket = socket.close() &amp;&amp; null;
    }
  });
});

internals._createBuffer = function _createBuffer(payload) {

  var value = '';

  if (_.isArray(payload)) {
    value = payload.join('\n');
  }

  return new Buffer(value);

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#description">description</a></li><li><a href="global.html#discover">discover</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getSocket">getSocket</a></li><li><a href="global.html#ip">ip</a></li><li><a href="global.html#nupnp">nupnp</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#send">send</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#upnp">upnp</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Wed May 27 2015 18:43:37 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
